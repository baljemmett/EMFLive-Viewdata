; Asterisk ODBC function definitions for EMF reminder call service
; #include this into /etc/asterisk/func_odbc.conf or equivalent.

; REMINDERCALLS_EventIdFromReminderCode(remindercode) -> event_id
[EventIdFromReminderCode]
prefix=REMINDERCALLS
dsn=reminder_calls
readsql=SELECT event_id FROM events WHERE remindercode = '${ARG1}'

; REMINDERCALLS_EventTitleFilenameFromId(event_id) -> title_phrase
[EventTitleFilenameFromId]
prefix=REMINDERCALLS
dsn=reminder_calls
readsql=SELECT title_phrase FROM events WHERE event_id = '${ARG1}'

; REMINDERCALLS_EventReminderFilenameFromId(event_id) -> reminder_phrase
[EventReminderFilenameFromId]
prefix=REMINDERCALLS
dsn=reminder_calls
readsql=SELECT reminder_phrase FROM events WHERE event_id = '${ARG1}'

; REMINDERCALLS_ScheduleForTime(phone_number, reminder_time) -> reminder_id
[ScheduleForTime]
prefix=REMINDERCALLS
dsn=reminder_calls
readsql=INSERT INTO reminders(phone_number, reminder_time, status, created, updated) VALUES ('${ARG1}', { ts '${ARG2}' }, 'pending', NOW(), NOW()) RETURNING reminder_id

; REMINDERCALLS_ScheduleForEvent(phone_number, event_id) -> reminder_id
[ScheduleForEvent]
prefix=REMINDERCALLS
dsn=reminder_calls
readsql=INSERT INTO reminders(phone_number, event_id, reminder_time, status, created, updated) SELECT '${ARG1}', event_id, start_time - INTERVAL '15' MINUTE, 'pending', NOW(), NOW() FROM events WHERE event_id = ${ARG2} RETURNING reminder_id

; REMINDERCALLS_AddHistoryEntry(reminder_id) = text
[AddHistoryEntry]
prefix=REMINDERCALLS
dsn=reminder_calls
writesql=INSERT INTO history(reminder_id, updated, log_entry) VALUES (${ARG1}, NOW(), '${VAL1}')

; REMINDERCALLS_GetPendingReminderCountForUser(phone_number) -> pending_count
[GetPendingReminderCountForUser]
prefix=REMINDERCALLS
dsn=reminder_calls

; REMINDERCALLS_GetPendingReminderIdsForUser(phone_number) -> reminder_id (multiple rows)
[GetPendingReminderIdsForUser]
prefix=REMINDERCALLS
dsn=reminder_calls
mode=multirow
readsql=SELECT reminder_id FROM reminders WHERE phone_number = '${ARG1}' AND status = 'pending' AND reminder_time > NOW()

; REMINDERCALLS_CancelReminderById(reminder_id) = [anything]
[CancelReminderById]
prefix=REMINDERCALLS
dsn=reminder_calls
writesql=UPDATE reminders SET status = 'cancelled', updated = NOW() WHERE reminder_id = ${ARG1}

; REMINDERCALLS_ReminderTimeFromId(reminder_id) -> 'day hh mm' (fixed-width fields)
[ReminderTimeFromId]
prefix=REMINDERCALLS
dsn=reminder_calls
readsql=SELECT TO_CHAR(reminder_time, 'dy HH24 MI') AS formatted_time FROM reminders WHERE reminder_id = ${ARG1}

; REMINDERCALLS_EventIdFromReminderId(reminder_id) -> event_id (possibly NULL)
[EventIdFromReminderId]
prefix=REMINDERCALLS
dsn=reminder_calls
readsql=SELECT event_id FROM reminders WHERE reminder_id = ${ARG1}
